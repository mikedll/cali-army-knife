#!/usr/bin/env ruby

require 'thor'
require 'action_mailer'
require 'cknife/config'


class CKnifeEmail < Thor

  class Mailer < ActionMailer::Base
    def email(from, recipient, subject, template_name)
      @var = "var"
      mail(:from => from,
           :to => recipient,
           :subject => subject,
           :template => template_name) do |format|
        format.text
        format.html
      end
    end
  end

  no_tasks do

    def config
      @config ||= CKnife::Config
    end
  end

  desc "mail [RECIPIENT] [SUBJECT] [TEMPLATE_NAME]", "Send an email to recipient."
  method_options :from => "no-reply@example.com"
  def mail(recipient, subject, template_name)

    ActionMailer::Base.raise_delivery_errors = true
    ActionMailer::Base.delivery_method = :smtp
    ActionMailer::Base.view_paths = Dir.getwd
    ActionMailer::Base.smtp_settings = {
      :address   => config.get('mail.address'),
      :port      => config.get('mail.port') || 587,
      :domain    => config.get('mail.domain'),
      :authentication => config.get('mail.authentication').to_sym,
      :user_name      => config.get('mail.username'),
      :password       => config.get('mail.password'),
      :enable_starttls_auto => true
    }

    from = if options[:from]
             options[:from]
           else
             config['mail.from']
           end

    email = CKnifeEmail.email(from, recipient, subject, template_name)
    puts email
    email.deliver
  end
end

CKnifeEmail.start
