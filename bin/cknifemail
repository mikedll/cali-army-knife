#!/usr/bin/env ruby

require 'thor'
require 'mail'
require 'cknife/config'

class CKnifeEmail < Thor

  no_tasks do
    def config
      @config ||= CKnife::Config
    end
  end

  desc "mail [RECIPIENT] [SUBJECT] [TEXT_FILE]", "Send an email to recipient."
  method_options :from => ""
  def mail(recipient, subject, text_file)
    smtp_settings = {
      :address   => config['mail.address'],
      :port      => config['mail.port'] || 587,
      :domain    => config['mail.domain'],
      :authentication => config['mail.authentication'].to_sym,
      :user_name      => config['mail.username'],
      :password       => config['mail.password'],
      :enable_starttls_auto => true
    }

    Mail.defaults do
      delivery_method :smtp, smtp_settings
    end

    from = !options[:from].blank? ? options[:from] : config['mail.from']
    if from.blank?
      say("No from address found. No action taken.")
      return
    end

    mail = Mail.new do
      from     from
      to       recipient
      subject  subject
      body     File.read(text_file)
    end

    mail.deliver

    say("Mail delivered to #{recipient}.")

  end
end

CKnifeEmail.start
