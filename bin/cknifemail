#!/usr/bin/env ruby

require 'thor'
require 'mail'
require 'cknife/config'

class CKnifeEmail < Thor

  no_tasks do
    def config
      @config ||= CKnife::Config
    end
  end

  desc "mail [RECIPIENT] [SUBJECT] [TEXT_FILE]", "Send an email to recipient."
  method_options :from => "no-reply@example.com"
  def mail(recipient, subject, text_file)
    Mail.defaults do
      delivery_method :smtp, {
        :address   => config['mail.address'],
        :port      => config['mail.port'] || 587,
        :domain    => config['mail.domain'],
        :authentication => config['mail.authentication'].to_sym,
        :user_name      => config['mail.username'],
        :password       => config['mail.password'],
        :enable_starttls_auto => true
      }
    end

    from = if options[:from]
             options[:from]
           else
             config['mail.from']
           end

    mail = Mail.new do
      from     from
      to       recipient
      subject  subject
      body     File.read(text_file)
    end
    puts mail
    email.deliver
  end
end

CKnifeEmail.start
